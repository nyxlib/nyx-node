/* NyxNode
 * Author: Jérôme ODIER <jerome.odier@lpsc.in2p3.fr>
 * SPDX-License-Identifier: GPL-2.0-only (Mongoose backend) or GPL-3.0+
 */


/*--------------------------------------------------------------------------------------------------------------------*/

#include <string.h>

#include "nyx_node_internal.h"

/*--------------------------------------------------------------------------------------------------------------------*/

typedef struct nyx_string_builder_node_s
{
    size_t len;

    uint32_t flags;

    struct nyx_string_builder_node_s *next;

} node_t;

/*--------------------------------------------------------------------------------------------------------------------*/

nyx_string_builder_t *nyx_string_builder_new()
{
    /*----------------------------------------------------------------------------------------------------------------*/

    nyx_string_builder_t *sb = nyx_memory_alloc(sizeof(nyx_string_builder_t));

    /*----------------------------------------------------------------------------------------------------------------*/

    sb->head = NULL;
    sb->tail = NULL;

    /*----------------------------------------------------------------------------------------------------------------*/

    return sb;
}

/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_string_builder_free(nyx_string_builder_t *sb)
{
    nyx_string_builder_clear(sb);

    nyx_memory_free(sb);
}

/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_string_builder_clear(nyx_string_builder_t *sb)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    for(node_t *node = sb->head; node != NULL;)
    {
        /*------------------------------------------------------------------------------------------------------------*/

        node_t *temp = node;

        node = node->next;

        /*------------------------------------------------------------------------------------------------------------*/

        nyx_memory_free(temp);

        /*------------------------------------------------------------------------------------------------------------*/
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    sb->head = NULL;
    sb->tail = NULL;

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_string_builder_append_buff(nyx_string_builder_t *sb, uint32_t flags, size_t len, STR_t str)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    node_t *node = nyx_memory_alloc(sizeof(node_t) + len + 1);

    memcpy((str_t) (node + 1), str, len);

    /*----------------------------------------------------------------------------------------------------------------*/

    node->len = len;
    node->flags = flags;
    node->next = NULL;

    /*----------------------------------------------------------------------------------------------------------------*/

    if(sb->head == NULL)
    {
        sb->head = node;
        sb->tail = node;
    }
    else
    {
        sb->tail->next = node;
        sb->tail /*-*/ = node;
    }

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_string_builder_append_n(nyx_string_builder_t *sb, uint32_t flags, STR_t args[], size_t n)
{
    for(size_t i = 0; i < n; i++)
    {
        STR_t str = args[i];

        if(str == NULL)
        {
            nyx_string_builder_append_buff(sb, NYX_SB_NO_ESCAPE, 6, "(null)");
        }
        else
        {
            nyx_string_builder_append_buff(sb, flags, strlen(str), str);
        }
    }
}

/*--------------------------------------------------------------------------------------------------------------------*/

size_t string_builder_length(const nyx_string_builder_t *sb, bool cstring)
{
    size_t result = 0;

    /*----------------------------------------------------------------------------------------------------------------*/

    for(node_t *node = sb->head; node != NULL; node = node->next)
    {
        str_t q = (str_t) (node + 1);

        size_t len = node->len;

        if((node->flags & NYX_SB_ESCAPE_JSON) != 0)
        {
            if(cstring) result++;

            if((node->flags & NYX_SB_ESCAPE_XML) != 0)
            {
                /*----------------------------------------------------------------------------------------------------*/

                for(; len > 0; len--)
                {
                    switch(*q++)
                    {
                    case '<':
                    case '>':
                        result += 4;
                        break;

                    case '&':
                        result += 5;
                        break;

                    case '\"':
                    case '\'':
                        result += 6;
                        break;

                    case '\\':
                    case '\b':
                    case '\f':
                    case '\n':
                    case '\r':
                    case '\t':
                        result += 2;
                        break;

                    default:
                        result += 1;
                        break;
                    }
                }

                /*----------------------------------------------------------------------------------------------------*/
            }
            else
            {
                /*----------------------------------------------------------------------------------------------------*/

                for(; len > 0; len--)
                {
                    switch(*q++)
                    {
                    case '\"':
                    case '\\':
                    case '\b':
                    case '\f':
                    case '\n':
                    case '\r':
                    case '\t':
                        result += 2;
                        break;

                    default:
                        result += 1;
                        break;
                    }
                }

                /*----------------------------------------------------------------------------------------------------*/
            }

            if(cstring) result++;
        }
        else
        {
            if((node->flags & NYX_SB_ESCAPE_XML) != 0)
            {
                /*----------------------------------------------------------------------------------------------------*/

                for(; len > 0; len--)
                {
                    switch(*q++)
                    {
                    case '<':
                    case '>':
                        result += 4;
                        break;

                    case '&':
                        result += 5;
                        break;

                    case '\"':
                    case '\'':
                        result += 6;
                        break;

                    default:
                        result += 1;
                        break;
                    }
                }
            }
            else
            {
                /*----------------------------------------------------------------------------------------------------*/

                result += len;

                /*----------------------------------------------------------------------------------------------------*/
            }
        }
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    return result;
}

/*--------------------------------------------------------------------------------------------------------------------*/

str_t string_builder_to_string(const nyx_string_builder_t *sb, bool cstring)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    str_t result = nyx_memory_alloc(nyx_string_builder_length(sb) + 1), p = result;

    /*----------------------------------------------------------------------------------------------------------------*/

    char c;

    for(node_t *node = sb->head; node != NULL; node = node->next)
    {
        str_t q = (str_t) (node + 1);

        size_t len = node->len;

        if((node->flags & NYX_SB_ESCAPE_JSON) != 0)
        {
            if(cstring) *p++ = '"';

            if((node->flags & NYX_SB_ESCAPE_XML) != 0)
            {
                /*----------------------------------------------------------------------------------------------------*/

                for(; len > 0; len--)
                {
                    switch((c = *q++))
                    {
                    case '<':
                        *p++ = '&'; *p++ = 'l'; *p++ = 't'; *p++ = ';'; break;

                    case '>':
                        *p++ = '&'; *p++ = 'g'; *p++ = 't'; *p++ = ';'; break;

                    case '&':
                        *p++ = '&'; *p++ = 'a'; *p++ = 'm'; *p++ = 'p'; *p++ = ';'; break;

                    case '\"':
                        *p++ = '&'; *p++ = 'q'; *p++ = 'u'; *p++ = 'o'; *p++ = 't'; *p++ = ';'; break;

                    case '\'':
                        *p++ = '&'; *p++ = 'a'; *p++ = 'p'; *p++ = 'o'; *p++ = 's'; *p++ = ';'; break;

                    case '\\': *p++ = '\\'; *p++ = '\\'; break;
                    case '\b': *p++ = '\\'; *p++ = 'b'; break;
                    case '\f': *p++ = '\\'; *p++ = 'f'; break;
                    case '\n': *p++ = '\\'; *p++ = 'n'; break;
                    case '\r': *p++ = '\\'; *p++ = 'r'; break;
                    case '\t': *p++ = '\\'; *p++ = 't'; break;

                    default:
                        *p++ = c;
                        break;
                    }
                }

                /*----------------------------------------------------------------------------------------------------*/
            }
            else
            {
                /*----------------------------------------------------------------------------------------------------*/

                for(; len > 0; len--)
                {
                    switch((c = *q++))
                    {
                    case '\"': *p++ = '\\'; *p++ = '\"'; break;
                    case '\\': *p++ = '\\'; *p++ = '\\'; break;
                    case '\b': *p++ = '\\'; *p++ = 'b'; break;
                    case '\f': *p++ = '\\'; *p++ = 'f'; break;
                    case '\n': *p++ = '\\'; *p++ = 'n'; break;
                    case '\r': *p++ = '\\'; *p++ = 'r'; break;
                    case '\t': *p++ = '\\'; *p++ = 't'; break;

                    default:
                        *p++ = c;
                        break;
                    }
                }

                /*----------------------------------------------------------------------------------------------------*/
            }

            if(cstring) *p++ = '"';
        }
        else
        {
            if((node->flags & NYX_SB_ESCAPE_XML) != 0)
            {
                /*----------------------------------------------------------------------------------------------------*/

                for(; len > 0; len--)
                {
                    switch((c = *q++))
                    {
                    case '<':
                        *p++ = '&'; *p++ = 'l'; *p++ = 't'; *p++ = ';'; break;

                    case '>':
                        *p++ = '&'; *p++ = 'g'; *p++ = 't'; *p++ = ';'; break;

                    case '&':
                        *p++ = '&'; *p++ = 'a'; *p++ = 'm'; *p++ = 'p'; *p++ = ';'; break;

                    case '\"':
                        *p++ = '&'; *p++ = 'q'; *p++ = 'u'; *p++ = 'o'; *p++ = 't'; *p++ = ';'; break;

                    case '\'':
                        *p++ = '&'; *p++ = 'a'; *p++ = 'p'; *p++ = 'o'; *p++ = 's'; *p++ = ';'; break;

                    default:
                        *p++ = c;
                        break;
                    }
                }

                /*----------------------------------------------------------------------------------------------------*/
            }
            else
            {
                /*----------------------------------------------------------------------------------------------------*/

                p = (str_t) memcpy(p, q, len) + len;

                /*----------------------------------------------------------------------------------------------------*/
            }
        }
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    *p = '\0';

    /*----------------------------------------------------------------------------------------------------------------*/

    return result;
}

/*--------------------------------------------------------------------------------------------------------------------*/

size_t nyx_string_builder_length(const nyx_string_builder_t *sb)
{
    return string_builder_length(sb, true);
}

/*--------------------------------------------------------------------------------------------------------------------*/

size_t nyx_string_builder_clength(const nyx_string_builder_t *sb)
{
    return string_builder_length(sb, false);
}

/*--------------------------------------------------------------------------------------------------------------------*/

str_t nyx_string_builder_to_string(const nyx_string_builder_t *sb)
{
    return string_builder_to_string(sb, true);
}

/*--------------------------------------------------------------------------------------------------------------------*/

str_t nyx_string_builder_to_cstring(const nyx_string_builder_t *sb)
{
    return string_builder_to_string(sb, false);
}

/*--------------------------------------------------------------------------------------------------------------------*/

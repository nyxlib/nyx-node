/*--------------------------------------------------------------------------------------------------------------------*/

#include <SPI.h>
#include <string.h>
#include <Arduino.h>

#include "arduino.h"

/*--------------------------------------------------------------------------------------------------------------------*/
/* NETWORK - UTILITIES                                                                                                */
/*--------------------------------------------------------------------------------------------------------------------*/

static void get_mac_addr(uint8_t mac[6], uint8_t mac0, uint8_t mac1, STR_t node_id)
{
    uint32_t hash = nyx_hash32(node_id, strlen(node_id), 0xAABBCCDD);

    mac[0] = mac0;
    mac[1] = mac1;
    mac[2] = (hash >> 24) & 0xFF;
    mac[3] = (hash >> 16) & 0xFF;
    mac[4] = (hash >> 8) & 0xFF;
    mac[5] = (hash >> 0) & 0xFF;
}

/*--------------------------------------------------------------------------------------------------------------------*/
/* NETWORK - W5500                                                                                                    */
/*--------------------------------------------------------------------------------------------------------------------*/
#if defined(MG_ENABLE_TCPIP) && defined(MG_ENABLE_DRIVER_W5500)
/*--------------------------------------------------------------------------------------------------------------------*/

int nyx_w5500_spi_cs_pin = -1;

/*--------------------------------------------------------------------------------------------------------------------*/

static void w5500_spi_beg(__UNUSED__ void *spi)
{
    digitalWrite(nyx_w5500_spi_cs_pin, LOW);
}

static void w5500_spi_end(__UNUSED__ void *spi)
{
    digitalWrite(nyx_w5500_spi_cs_pin, HIGH);
}

static uint8_t w5500_spi_txn(__UNUSED__ void *spi, uint8_t c)
{
    return SPI.transfer(c);
}

/*--------------------------------------------------------------------------------------------------------------------*/

static struct mg_tcpip_spi w5500_spi = {
    nullptr,
    w5500_spi_beg,
    w5500_spi_end,
    w5500_spi_txn,
};

/*--------------------------------------------------------------------------------------------------------------------*/

static struct mg_tcpip_if w5500_if = {
    .driver = &mg_tcpip_driver_w5500,
    .driver_data = &w5500_spi,
};

/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_arduino_init_w5500(struct mg_mgr *mgr, STR_t node_id)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    pinMode(nyx_w5500_spi_cs_pin, OUTPUT);

    /*----------------------------------------------------------------------------------------------------------------*/

    get_mac_addr(w5500_if.mac, 0xEF, 0x02, node_id);

    mg_tcpip_init(mgr, &w5500_if);

    /*----------------------------------------------------------------------------------------------------------------*/

    MG_INFO(("MAC: %M. Waiting for IP...", mg_print_mac, w5500_if.mac));

    while(w5500_if.state != MG_TCPIP_STATE_READY)
    {
        mg_mgr_poll(mgr, 0);
    }

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/
#endif
/*--------------------------------------------------------------------------------------------------------------------*/
/* CONSOLE                                                                                                            */
/*--------------------------------------------------------------------------------------------------------------------*/

void nyx_arduino_console(char c, __UNUSED__ buff_t params)
{
    if(Serial)
    {
        Serial.print(c);
    }
}

/*--------------------------------------------------------------------------------------------------------------------*/

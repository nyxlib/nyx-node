/*--------------------------------------------------------------------------------------------------------------------*/

#include <stdio.h>

#include <libxml/xmlschemas.h>

#include "indi_base_internal.h"

#include "indi_base_schema.h"

/*--------------------------------------------------------------------------------------------------------------------*/

static xmlSchema *INDI_SCHEMA = NULL;

/*--------------------------------------------------------------------------------------------------------------------*/

bool indi_validation_finalize()
{
    if(INDI_SCHEMA != NULL)
    {
        xmlSchemaFree(INDI_SCHEMA);

        INDI_SCHEMA = NULL;
    }

    return true;
}

/*--------------------------------------------------------------------------------------------------------------------*/

bool indi_validation_initialize()
{
    if(INDI_SCHEMA != NULL)
    {
        return true;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    xmlSchemaParserCtxt *context = xmlSchemaNewMemParserCtxt(indi_base_xsd_buff, INDI_BASE_XSD_SIZE);

    if(context == NULL)
    {
        return false;
    }

    /**/    /*--------------------------------------------------------------------------------------------------------*/
    /**/
    /**/    xmlSchemaSetParserErrors(
    /**/        context,
    /**/        (xmlSchemaValidityErrorFunc) fprintf,
    /**/        (xmlSchemaValidityWarningFunc) fprintf,
    /**/        stderr
    /**/    );
    /**/
    /**/    /*--------------------------------------------------------------------------------------------------------*/
    /**/
    /**/    INDI_SCHEMA = xmlSchemaParse(context);
    /**/
    /**/    /*--------------------------------------------------------------------------------------------------------*/

    xmlSchemaFreeParserCtxt(context);

    /*----------------------------------------------------------------------------------------------------------------*/

    return INDI_SCHEMA != NULL;

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

bool indi_validation_check(struct _xmlDoc *doc)
{
    if(INDI_SCHEMA == NULL)
    {
        return false;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    xmlSchemaValidCtxt *context = xmlSchemaNewValidCtxt(INDI_SCHEMA);

    if(context == NULL)
    {
        return false;
    }

    /**/    /*--------------------------------------------------------------------------------------------------------*/
    /**/
    /**/    xmlSchemaSetValidErrors(
    /**/        context,
    /**/        (xmlSchemaValidityErrorFunc) fprintf,
    /**/        (xmlSchemaValidityWarningFunc) fprintf,
    /**/        stderr
    /**/    );
    /**/
    /**/    /*--------------------------------------------------------------------------------------------------------*/
    /**/
    /**/    int result = xmlSchemaValidateDoc(context, (xmlDoc *) doc);
    /**/
    /**/    /*--------------------------------------------------------------------------------------------------------*/

    xmlSchemaFreeValidCtxt(context);

    /*----------------------------------------------------------------------------------------------------------------*/

    return result == XML_SCHEMAS_ERR_OK;

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

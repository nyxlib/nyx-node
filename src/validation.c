/*--------------------------------------------------------------------------------------------------------------------*/

#include <stdio.h>

#include <libxml/xmlschemas.h>

#include "nyx_node_schema.h"
#include "nyx_node_internal.h"

/*--------------------------------------------------------------------------------------------------------------------*/

static xmlSchema *NYX_SCHEMA = NULL;

/*--------------------------------------------------------------------------------------------------------------------*/

bool nyx_validation_finalize()
{
    if(NYX_SCHEMA != NULL)
    {
        xmlSchemaFree(NYX_SCHEMA);

        NYX_SCHEMA = NULL;
    }

    return true;
}

/*--------------------------------------------------------------------------------------------------------------------*/

bool nyx_validation_initialize()
{
    if(NYX_SCHEMA != NULL)
    {
        return true;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    xmlSchemaParserCtxt *context = xmlSchemaNewMemParserCtxt(nyx_node_xsd_buff, NYX_NODE_XSD_SIZE);

    if(context == NULL)
    {
        return false;
    }

    /**/    /*--------------------------------------------------------------------------------------------------------*/
    /**/
    /**/    xmlSchemaSetParserErrors(
    /**/        context,
    /**/        (xmlSchemaValidityErrorFunc) fprintf,
    /**/        (xmlSchemaValidityWarningFunc) fprintf,
    /**/        stderr
    /**/    );
    /**/
    /**/    /*--------------------------------------------------------------------------------------------------------*/
    /**/
    /**/    NYX_SCHEMA = xmlSchemaParse(context);
    /**/
    /**/    /*--------------------------------------------------------------------------------------------------------*/

    xmlSchemaFreeParserCtxt(context);

    /*----------------------------------------------------------------------------------------------------------------*/

    return NYX_SCHEMA != NULL;

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

bool nyx_validation_check(const nyx_xmldoc_t *xmldoc)
{
    if(NYX_SCHEMA == NULL)
    {
        return false;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    xmlSchemaValidCtxt *context = xmlSchemaNewValidCtxt(NYX_SCHEMA);

    if(context == NULL)
    {
        return false;
    }

    /**/    /*--------------------------------------------------------------------------------------------------------*/
    /**/
    /**/    xmlSchemaSetValidErrors(
    /**/        context,
    /**/        (xmlSchemaValidityErrorFunc) fprintf,
    /**/        (xmlSchemaValidityWarningFunc) fprintf,
    /**/        stderr
    /**/    );
    /**/
    /**/    /*--------------------------------------------------------------------------------------------------------*/
    /**/
    /**/    int result = xmlSchemaValidateDoc(context, (xmlDoc *) xmldoc);
    /**/
    /**/    /*--------------------------------------------------------------------------------------------------------*/

    xmlSchemaFreeValidCtxt(context);

    /*----------------------------------------------------------------------------------------------------------------*/

    return result == XML_SCHEMAS_ERR_OK;

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

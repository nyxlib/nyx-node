/* NyxNode
 * Author: Jérôme ODIER <jerome.odier@lpsc.in2p3.fr>
 * SPDX-License-Identifier: GPL-2.0-only (Mongoose backend) or GPL-3.0+
 */

/*--------------------------------------------------------------------------------------------------------------------*/

#include "../nyx_node_internal.h"

/*--------------------------------------------------------------------------------------------------------------------*/

static const uint32_t ADLER_MOD = 65521u;

static const uint32_t ADLER_N_MAX = 5552u;

/*--------------------------------------------------------------------------------------------------------------------*/

uint32_t nyx_hash32(__ZEROABLE__ size_t src_size, __NULLABLE__ BUFF_t src_buff, uint32_t seed)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    const uint8_t *p = (const uint8_t *) src_buff;

    /*----------------------------------------------------------------------------------------------------------------*/

    uint32_t a = (seed >> 0) & 0xFFFFu;
    uint32_t b = (seed >> 16) & 0xFFFFu;

    a %= ADLER_MOD;
    b %= ADLER_MOD;

    /*----------------------------------------------------------------------------------------------------------------*/

    if(src_size == 0x00 || src_buff == NULL)
    {
        return (b << 16) | (a << 0);
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    while(src_size > 0)
    {
        size_t t = (src_size > ADLER_N_MAX) ? ADLER_N_MAX : src_size;

        src_size -= t;

        for(; t >= 4; t -= 4)
        {
            a += *p++; b += a;
            a += *p++; b += a;
            a += *p++; b += a;
            a += *p++; b += a;
        }

        for(; t > 0; t -= 1)
        {
            a += *p++; b += a;
        }

        a %= ADLER_MOD;
        b %= ADLER_MOD;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    return (b << 16) | (a << 0);
}

/*--------------------------------------------------------------------------------------------------------------------*/
